<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>재고 현황 관리</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Google Sheets API URL
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwqJpT4bfPBAB1Z2_njB7hKmG9JF52RjGyMhQoL_9h8s6XwU2jK0O80nhBZhmS11zNa/exec';

        // 품목 이름 매핑
        const ITEM_NAMES = [
            '0후지', '3후지', 'S후지', '등심', '지방', '사골', '단족',
            '삼겹(등갈비X)', '삼겹(등갈비O)', '롤삼겹', '갈비(3대)', '갈비(4대)',
            '목살', 'B목살', 'T등뼈', 'T목뼈', '싹뼈', '안심', '잡육', '갈매기',
            '한우스지', '한우사골', '한우잡뼈', '목전지', '대패', '깐양'
        ];

        // Package 아이콘 컴포넌트
        const Package = ({ size = 24, className = "" }) => (
            <svg 
                width={size} 
                height={size} 
                viewBox="0 0 24 24" 
                fill="none" 
                stroke="currentColor" 
                strokeWidth="2" 
                strokeLinecap="round" 
                strokeLinejoin="round"
                className={className}
            >
                <line x1="16.5" y1="9.4" x2="7.5" y2="4.21"></line>
                <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                <line x1="12" y1="22.08" x2="12" y2="12"></line>
            </svg>
        );

        function InventoryManager() {
            const [inventory, setInventory] = useState([]);
            const [selectedItem, setSelectedItem] = useState(null);
            const [loading, setLoading] = useState(true);
            const [syncing, setSyncing] = useState(false);
            const [longPressItem, setLongPressItem] = useState(null);
            const [showAddModal, setShowAddModal] = useState(false);
            const [newItemName, setNewItemName] = useState('');
            
            let pressTimer = null;

            // 초기 데이터 로드
            useEffect(() => {
                loadInventory();
            }, []);

            // Google Sheets에서 데이터 가져오기
            const loadInventory = async () => {
                try {
                    setLoading(true);
                    const response = await fetch(SCRIPT_URL);
                    const data = await response.json();
                    
                    // 품목 이름 추가 (기존 품목은 ITEM_NAMES 사용, 새 품목은 시트의 name 사용)
                    const inventoryWithNames = data.map((item, index) => ({
                        ...item,
                        name: item.name || ITEM_NAMES[index] || `품목${item.id}`
                    }));
                    
                    setInventory(inventoryWithNames);
                } catch (error) {
                    console.error('데이터 로드 실패:', error);
                    alert('데이터를 불러오는데 실패했습니다. 페이지를 새로고침 해주세요.');
                } finally {
                    setLoading(false);
                }
            };

            // Google Sheets에 데이터 저장 (GET 방식으로 변경)
            const saveToSheet = async (id, boxStock, packStock, name) => {
                try {
                    setSyncing(true);
                    const url = `${SCRIPT_URL}?action=save&id=${id}&boxStock=${boxStock}&packStock=${packStock}&name=${encodeURIComponent(name)}`;
                    const response = await fetch(url);
                    
                    if (!response.ok) {
                        throw new Error('저장 실패');
                    }
                    
                    const result = await response.json();
                    if (!result.success) {
                        throw new Error('저장 실패');
                    }
                } catch (error) {
                    console.error('저장 실패:', error);
                    alert('저장에 실패했습니다. 다시 시도해주세요.');
                } finally {
                    setSyncing(false);
                }
            };
            
            // 품목 추가
            const addItem = async () => {
                if (!newItemName.trim()) {
                    alert('품목명을 입력해주세요.');
                    return;
                }
                
                const newId = inventory.length > 0 ? Math.max(...inventory.map(item => item.id)) + 1 : 1;
                const newItem = {
                    id: newId,
                    name: newItemName.trim(),
                    boxStock: 0,
                    packStock: 0
                };
                
                // 로컬 상태 업데이트
                setInventory([...inventory, newItem]);
                
                // Google Sheets에 저장
                await saveToSheet(newId, 0, 0, newItemName.trim());
                
                // 모달 닫기
                setShowAddModal(false);
                setNewItemName('');
            };
            
            // 품목 삭제
            const deleteItem = async (id) => {
                if (!confirm('이 품목을 삭제하시겠습니까?')) {
                    return;
                }
                
                try {
                    setSyncing(true);
                    const url = `${SCRIPT_URL}?action=delete&id=${id}`;
                    const response = await fetch(url);
                    
                    if (!response.ok) {
                        throw new Error('삭제 실패');
                    }
                    
                    const result = await response.json();
                    if (!result.success) {
                        throw new Error('삭제 실패');
                    }
                    
                    // 로컬 상태 업데이트
                    setInventory(inventory.filter(item => item.id !== id));
                    setLongPressItem(null);
                } catch (error) {
                    console.error('삭제 실패:', error);
                    alert('삭제에 실패했습니다. 다시 시도해주세요.');
                } finally {
                    setSyncing(false);
                }
            };
            
            // 품목 순서 이동
            const moveItem = async (id, direction) => {
                const currentIndex = inventory.findIndex(item => item.id === id);
                if (currentIndex === -1) return;
                
                const newIndex = direction === 'up' ? currentIndex - 1 : currentIndex + 1;
                
                // 범위 체크
                if (newIndex < 0 || newIndex >= inventory.length) return;
                
                // 배열 순서 변경
                const newInventory = [...inventory];
                const [movedItem] = newInventory.splice(currentIndex, 1);
                newInventory.splice(newIndex, 0, movedItem);
                
                // 로컬 상태 업데이트
                setInventory(newInventory);
                
                // Google Sheets에 순서 저장
                try {
                    setSyncing(true);
                    const url = `${SCRIPT_URL}?action=reorder&order=${encodeURIComponent(JSON.stringify(newInventory.map(item => item.id)))}`;
                    const response = await fetch(url);
                    
                    if (!response.ok) {
                        throw new Error('순서 저장 실패');
                    }
                } catch (error) {
                    console.error('순서 저장 실패:', error);
                    alert('순서 저장에 실패했습니다.');
                } finally {
                    setSyncing(false);
                }
            };
            
            // 롱프레스 시작
            const handlePressStart = (id, e) => {
                if (e) {
                    // 마우스 이벤트에만 preventDefault (드래그 방지)
                    if (e.type === 'mousedown') {
                        e.preventDefault();
                    }
                    e.stopPropagation();
                }
                
                // 기존 타이머 클리어
                if (pressTimer) {
                    clearTimeout(pressTimer);
                }
                
                pressTimer = setTimeout(() => {
                    setLongPressItem(id);
                    pressTimer = null;
                }, 500); // 0.5초 꾹 누르기
            };
            
            // 롱프레스 취소 (타이머만 클리어, 상태는 유지)
            const handlePressEnd = (e) => {
                if (e) {
                    e.stopPropagation();
                }
                if (pressTimer) {
                    clearTimeout(pressTimer);
                    pressTimer = null;
                }
            };
            
            // 마우스/터치 이동 시 취소
            const handlePressMove = (e) => {
                if (pressTimer) {
                    clearTimeout(pressTimer);
                    pressTimer = null;
                }
            };

            const updateStock = async (id, unit, change) => {
                // 로컬 상태 업데이트
                const updatedInventory = inventory.map(item => {
                    if (item.id === id) {
                        if (unit === 'box') {
                            const newStock = Math.max(0, item.boxStock + change);
                            // Google Sheets에 저장
                            saveToSheet(id, newStock, item.packStock, item.name);
                            return { ...item, boxStock: newStock };
                        } else {
                            const newStock = Math.max(0, item.packStock + change);
                            // Google Sheets에 저장
                            saveToSheet(id, item.boxStock, newStock, item.name);
                            return { ...item, packStock: newStock };
                        }
                    }
                    return item;
                });
                
                setInventory(updatedInventory);
            };

            const handleItemClick = (id) => {
                if (longPressItem === id) {
                    // 롱프레스 모드인 품목을 다시 클릭하면 롱프레스 모드 해제
                    setLongPressItem(null);
                    return;
                }
                if (longPressItem !== null) {
                    // 다른 품목이 롱프레스 모드일 때는 그것만 해제
                    setLongPressItem(null);
                    return;
                }
                setSelectedItem(selectedItem === id ? null : id);
            };

            if (loading) {
                return (
                    <div className="w-full min-h-screen bg-gray-100 flex items-center justify-center">
                        <div className="text-center">
                            <div className="text-2xl font-bold text-black mb-2">로딩중...</div>
                            <div className="text-gray-600">데이터를 불러오는 중입니다</div>
                        </div>
                    </div>
                );
            }

            return (
                <>
                <div className="w-full min-h-screen bg-gray-100 overflow-auto" onClick={() => {
                    if (longPressItem !== null) {
                        setLongPressItem(null);
                    }
                }}>
                    <div className="min-h-screen flex flex-col max-w-7xl mx-auto">
                        <div className="bg-black shadow-md p-3 sm:p-4 flex-shrink-0 sticky top-0 z-10">
                            <div className="flex items-center justify-center gap-2 sm:gap-3">
                                <Package size={24} className="text-white sm:hidden" />
                                <Package size={28} className="text-white hidden sm:block" />
                                <h1 className="text-2xl sm:text-3xl font-bold text-white">재고 현황</h1>
                                {syncing && (
                                    <div className="ml-2 text-xs sm:text-sm text-yellow-300">동기화 중...</div>
                                )}
                            </div>
                        </div>

                        <div className="flex-1 p-2 sm:p-4 pb-28 sm:pb-40">
                            <div className="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-2 sm:gap-3">
                                {inventory.map((item) => (
                                    <div key={item.id} className="relative">
                                        <div
                                            onClick={(e) => {
                                                e.stopPropagation();
                                                handleItemClick(item.id);
                                            }}
                                            onMouseDown={(e) => handlePressStart(item.id, e)}
                                            onMouseUp={(e) => handlePressEnd(e)}
                                            onMouseLeave={(e) => handlePressMove(e)}
                                            onMouseMove={(e) => {
                                                if (pressTimer) {
                                                    handlePressMove(e);
                                                }
                                            }}
                                            onTouchStart={(e) => handlePressStart(item.id, e)}
                                            onTouchEnd={(e) => handlePressEnd(e)}
                                            onTouchCancel={(e) => handlePressMove(e)}
                                            onTouchMove={(e) => {
                                                if (pressTimer) {
                                                    handlePressMove(e);
                                                }
                                            }}
                                            onContextMenu={(e) => e.preventDefault()}
                                            style={{ userSelect: 'none', WebkitUserSelect: 'none' }}
                                            className={`border-2 rounded-xl p-2 sm:p-3 cursor-pointer transition-all ${
                                                selectedItem === item.id
                                                    ? 'border-black bg-gray-200 shadow-lg'
                                                    : longPressItem === item.id
                                                    ? 'border-red-500 bg-red-50'
                                                    : 'border-gray-400 bg-white hover:border-gray-600 hover:shadow-md'
                                            }`}
                                        >
                                            {longPressItem === item.id && (
                                                <>
                                                    {/* 삭제 버튼 */}
                                                    <button
                                                        onClick={(e) => {
                                                            e.stopPropagation();
                                                            deleteItem(item.id);
                                                        }}
                                                        className="absolute -top-2 -right-2 w-8 h-8 bg-red-600 text-white rounded-full font-bold text-lg shadow-lg z-10 flex items-center justify-center"
                                                    >
                                                        ×
                                                    </button>
                                                    
                                                    {/* 위로 이동 버튼 */}
                                                    {inventory.findIndex(i => i.id === item.id) > 0 && (
                                                        <button
                                                            onClick={(e) => {
                                                                e.stopPropagation();
                                                                moveItem(item.id, 'up');
                                                            }}
                                                            className="absolute -top-2 -left-2 w-8 h-8 bg-blue-600 text-white rounded-full font-bold text-lg shadow-lg z-10 flex items-center justify-center"
                                                        >
                                                            ↑
                                                        </button>
                                                    )}
                                                    
                                                    {/* 아래로 이동 버튼 */}
                                                    {inventory.findIndex(i => i.id === item.id) < inventory.length - 1 && (
                                                        <button
                                                            onClick={(e) => {
                                                                e.stopPropagation();
                                                                moveItem(item.id, 'down');
                                                            }}
                                                            className="absolute -bottom-2 -left-2 w-8 h-8 bg-blue-600 text-white rounded-full font-bold text-lg shadow-lg z-10 flex items-center justify-center"
                                                        >
                                                            ↓
                                                        </button>
                                                    )}
                                                </>
                                            )}
                                            <h3 className="text-sm sm:text-base font-bold text-black mb-1 sm:mb-2 text-center">
                                                {item.name}
                                            </h3>
                                            <div className="space-y-1">
                                                <div className="flex items-center justify-center gap-1 sm:gap-2">
                                                    <span className="text-xl sm:text-2xl font-bold text-red-600">
                                                        {item.boxStock}
                                                    </span>
                                                    <span className="text-xs sm:text-sm text-gray-600 font-medium">
                                                        박스
                                                    </span>
                                                </div>
                                                <div className="flex items-center justify-center gap-1 sm:gap-2">
                                                    <span className="text-xl sm:text-2xl font-bold text-blue-600">
                                                        {item.packStock}
                                                    </span>
                                                    <span className="text-xs sm:text-sm text-gray-600 font-medium">
                                                        팩
                                                    </span>
                                                </div>
                                            </div>
                                        </div>

                                        {selectedItem === item.id && longPressItem !== item.id && (
                                            <div className="mt-2 bg-white border-2 border-black rounded-xl p-2 sm:p-3 shadow-lg">
                                                {/* 박스 조절 */}
                                                <div className="mb-2 sm:mb-3">
                                                    <div className="text-xs sm:text-sm font-bold text-red-600 mb-1 text-center">박스 (B)</div>
                                                    <div className="grid grid-cols-4 gap-1 sm:gap-2">
                                                        <button
                                                            onClick={(e) => {
                                                                e.stopPropagation();
                                                                updateStock(item.id, 'box', -5);
                                                            }}
                                                            className="py-2 sm:py-2 text-sm sm:text-base bg-gray-600 text-white rounded-lg active:bg-gray-800 transition-colors font-bold"
                                                        >
                                                            -5
                                                        </button>
                                                        <button
                                                            onClick={(e) => {
                                                                e.stopPropagation();
                                                                updateStock(item.id, 'box', -1);
                                                            }}
                                                            className="py-2 sm:py-2 text-sm sm:text-base bg-gray-500 text-white rounded-lg active:bg-gray-700 transition-colors font-bold"
                                                        >
                                                            -1
                                                        </button>
                                                        <button
                                                            onClick={(e) => {
                                                                e.stopPropagation();
                                                                updateStock(item.id, 'box', 1);
                                                            }}
                                                            className="py-2 sm:py-2 text-sm sm:text-base bg-red-500 text-white rounded-lg active:bg-red-700 transition-colors font-bold"
                                                        >
                                                            +1
                                                        </button>
                                                        <button
                                                            onClick={(e) => {
                                                                e.stopPropagation();
                                                                updateStock(item.id, 'box', 5);
                                                            }}
                                                            className="py-2 sm:py-2 text-sm sm:text-base bg-red-600 text-white rounded-lg active:bg-red-800 transition-colors font-bold"
                                                        >
                                                            +5
                                                        </button>
                                                    </div>
                                                </div>

                                                {/* 팩 조절 */}
                                                <div>
                                                    <div className="text-xs sm:text-sm font-bold text-blue-600 mb-1 text-center">팩 (P)</div>
                                                    <div className="grid grid-cols-4 gap-1 sm:gap-2">
                                                        <button
                                                            onClick={(e) => {
                                                                e.stopPropagation();
                                                                updateStock(item.id, 'pack', -5);
                                                            }}
                                                            className="py-2 sm:py-2 text-sm sm:text-base bg-gray-600 text-white rounded-lg active:bg-gray-800 transition-colors font-bold"
                                                        >
                                                            -5
                                                        </button>
                                                        <button
                                                            onClick={(e) => {
                                                                e.stopPropagation();
                                                                updateStock(item.id, 'pack', -1);
                                                            }}
                                                            className="py-2 sm:py-2 text-sm sm:text-base bg-gray-500 text-white rounded-lg active:bg-gray-700 transition-colors font-bold"
                                                        >
                                                            -1
                                                        </button>
                                                        <button
                                                            onClick={(e) => {
                                                                e.stopPropagation();
                                                                updateStock(item.id, 'pack', 1);
                                                            }}
                                                            className="py-2 sm:py-2 text-sm sm:text-base bg-blue-500 text-white rounded-lg active:bg-blue-700 transition-colors font-bold"
                                                        >
                                                            +1
                                                        </button>
                                                        <button
                                                            onClick={(e) => {
                                                                e.stopPropagation();
                                                                updateStock(item.id, 'pack', 5);
                                                            }}
                                                            className="py-2 sm:py-2 text-sm sm:text-base bg-blue-600 text-white rounded-lg active:bg-blue-800 transition-colors font-bold"
                                                        >
                                                            +5
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
                
                {/* 품목 추가 버튼 (하단 고정) */}
                <div className="fixed bottom-0 left-0 right-0 p-4 bg-white border-t-2 border-gray-300 shadow-lg">
                    <button
                        onClick={() => setShowAddModal(true)}
                        className="w-full max-w-md mx-auto flex items-center justify-center gap-2 py-3 bg-black text-white rounded-lg font-bold text-lg active:bg-gray-800 transition-colors"
                    >
                        <span className="text-2xl">+</span>
                        <span>품목 추가</span>
                    </button>
                </div>
                
                {/* 품목 추가 모달 */}
                {showAddModal && (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                        <div className="bg-white rounded-xl p-6 w-full max-w-md">
                            <h2 className="text-2xl font-bold text-black mb-4">새 품목 추가</h2>
                            <input
                                type="text"
                                value={newItemName}
                                onChange={(e) => setNewItemName(e.target.value)}
                                placeholder="품목명 입력"
                                className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg text-lg mb-4 focus:outline-none focus:border-black"
                                autoFocus
                            />
                            <div className="flex gap-3">
                                <button
                                    onClick={() => {
                                        setShowAddModal(false);
                                        setNewItemName('');
                                    }}
                                    className="flex-1 py-3 bg-gray-300 text-black rounded-lg font-bold active:bg-gray-400 transition-colors"
                                >
                                    취소
                                </button>
                                <button
                                    onClick={addItem}
                                    className="flex-1 py-3 bg-black text-white rounded-lg font-bold active:bg-gray-800 transition-colors"
                                >
                                    추가
                                </button>
                            </div>
                        </div>
                    </div>
                )}
                </>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<InventoryManager />);
    </script>
</body>
</html>
